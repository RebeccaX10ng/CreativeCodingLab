<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Create My Album</title>
  <link rel="stylesheet" href="css/style.css">

  <script src="js/lib/p5.js"></script>
  <script src="js/lib/p5.sound.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.1/addons/p5.sound.min.js"></script> -->
  <!-- //embed a font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sedan:ital@0;1&display=swap" rel="stylesheet">
  <!-- firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
</head>

<body>
  <div id="sideMenuBtn">&#9776;</div>
  <nav id="sideMenu" class="side-menu">
    <div class="side-menu-categories">
      <a href="#" class="side-menu-link">Public Gallery</a>
      <a href="my-creations.html" id="myCollectionsLink" class="side-menu-link">My Collections</a>
      <a href="select_a_template.html" class="side-menu-link">Create My Record</a>
    </div>
    <div id="authContainer" class="side-menu-bottom">
      <a href="#" class="side-menu-signin">Sign In</a>
    </div>
  </nav>
  <script>
    const menuBtn = document.getElementById('sideMenuBtn');
    const sideMenu = document.getElementById('sideMenu');
    menuBtn.onclick = () => {
      sideMenu.classList.toggle('open');
    };
    document.addEventListener('click', (e) => {
      if (!sideMenu.contains(e.target) && e.target !== menuBtn) {
        sideMenu.classList.remove('open');
      }
    });
  </script>

  <h1 class="title">
    <span class="titleItalic">CREATE</span> <span class="titleNormal">A New Album</span>
  </h1>

  <div id="return">
    <a href="select_a_template.html">
      Try Other Templates
    </a>
  </div>

  <div id="wrapper">
    <div id="canvasContainer">
      <!-- p5 canvas will be appended here! -->
    </div>
    <div id="inputBox">
      <input id="albumName" type="text" placeholder="Insert Your Album Name">
    </div>
    <!-- <div id="captureButton"><button id="capture">Save!</button></div> -->
    <!-- </div> -->
    <div id="checkBoxAlbumName">
      <input type="checkbox" id="showName">
      <label for="showName">Show Album Name on the Cover</label>
    </div>
    <!-- <div id="colorPicker"> <label for="color-picker">Select a color:</label>
    <input id="color-picker" type="color">
    <label for="color-picker-background">Background color:</label>
    <input id="color-picker-background" type="color">
  </div> -->
    <div id="captureButton">
      <button id="capture" onclick="toggleFreeze()" class="btns">Freeze Image</button>
      <button id="saveImage" onclick="saveLocalImage()" class="btns">Save Image</button>
      <button id="record" class="btns" onclick="startRecording()">Record Audio</button>
      <button id="play" class="btns" onclick="playRecording()">Play Audio</button>
      <button id="saveAudio" class="btns" onclick="saveAudioRecording()">Save Audio</button>

      <button id="share" class="btns" onclick="uploadAndShare()">Share</button>
    </div>

    <div id="shareLinkContainer" style="text-align: center; margin-top: 1em; word-wrap: break-word;"></div>
  </div>

  <script>
    function changeButtonText() {
      var button = document.getElementById("capture");
      if (button.innerHTML === "Save!") {
        button.innerHTML = "Resume";
      } else {
        button.innerHTML = "Save!";
      }
    }
  </script>

  <script src="js/album_0_tint.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBOTjmMPnN16vh6zd6TQ3MVV1I1fqCpQ2U",
      authDomain: "days-records.firebaseapp.com",
      projectId: "days-records",
      storageBucket: "days-records.firebasestorage.app",
      messagingSenderId: "454621890868",
      appId: "1:454621890868:web:9095c79739212ca4e3bd61",
      measurementId: "G-7ZKGPTRHPP"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();
    const auth = firebase.auth(); // 【【【 添加这一行代码！ 】】】

    //Upload and share
    // createAlbum_0_tint.html 的最后一个 <script> 标签内

    // ... Firebase 初始化代码之后 ...

    //Upload and share
    async function uploadAndShare() {
      try {
        const user = auth.currentUser;
        if (user) {
          console.log("Sharing as logged-in user:", user.uid);
        } else {
          console.log("Sharing as an anonymous user.");
        }

        if (!frozenImage) {
          alert('Please freeze an image before sharing!');
          return;
        }

        const shareButton = document.getElementById('share');
        shareButton.disabled = true;
        shareButton.textContent = 'Uploading...';

        let imageBlob = null;
        let audioBlob = null;
        let imageUrl = null;
        let audioUrl = null;

        try {
          imageBlob = await new Promise(resolve => frozenImage.canvas.toBlob(resolve, 'image/png'));
        } catch (error) {
          console.error("Error getting image data:", error);
          alert("Could not get image data. Sharing failed.");
          shareButton.disabled = false;
          shareButton.textContent = 'Share';
          return;
        }

        try {
          if (soundFile && soundFile.isLoaded() && soundFile.duration() > 0) {
            audioBlob = soundFile.getBlob();
          } else {
            console.log("No valid audio recorded. Sharing image only.");
          }
        } catch (e) {
          console.warn("Could not get audio blob, possibly due to recording error. Sharing image only.", e);
          audioBlob = null;
        }

        const uniqueId = Date.now();
        const imagePath = `creations/${uniqueId}-album.png`;
        const audioPath = `creations/${uniqueId}-recording.wav`;

        const imageRef = storage.ref(imagePath);
        await imageRef.put(imageBlob);
        imageUrl = await imageRef.getDownloadURL();

        if (audioBlob) {
          const audioRef = storage.ref(audioPath);
          await audioRef.put(audioBlob);
          audioUrl = await audioRef.getDownloadURL();
        }

        const dataToSave = {
          imageUrl: imageUrl,
          audioUrl: audioUrl,
          albumName: document.getElementById("albumName").value || "Untitled Album",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          userId: user ? user.uid : null
        };

        const creationRef = await db.collection("creations").add(dataToSave);

        let currentURL = window.location.href;
        let baseURL = currentURL.substring(0, currentURL.lastIndexOf('/') + 1);
        const shareLink = `${baseURL}share.html?id=${creationRef.id}`;

        document.getElementById('shareLinkContainer').innerHTML =
          `Share this link: <a href="${shareLink}" target="_blank">${shareLink}</a>`;

        alert('Success! Your creation is ready to be shared.');

        shareButton.disabled = false;
        shareButton.textContent = 'Share';

      } catch (error) {
        console.error("Upload failed:", error);
        alert('Upload failed. Please check the console for details.');
        const shareButton = document.getElementById('share');
        shareButton.disabled = false;
        shareButton.textContent = 'Share';
      }
    }
  </script>
</body>

</html>